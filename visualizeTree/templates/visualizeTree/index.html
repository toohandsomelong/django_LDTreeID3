{% extends "base/base.html" %}

{% block title %}Visualize Tree{% endblock %}

{% block content %}
    <h1>Decision Tree Visualization</h1>
    <div id="tree-container" style="width: 100%; height: 1500px; background: var(--bg-color); border: 1px solid var(--accent-color); overflow: hidden;"></div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        const treeData = {{ tree_dict|safe }};

        const margin = {top: 20, right: 120, bottom: 20, left: 120},
              width = 2000 - margin.right - margin.left,
              height = 1500 - margin.top - margin.bottom;

        const svg = d3.select("#tree-container").append("svg")
            .attr("width", width + margin.right + margin.left)
            .attr("height", height + margin.top + margin.bottom)
            .style("max-width", "100%")
            .style("height", "auto");

        const g = svg.append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on("zoom", function(event) {
                g.attr("transform", event.transform);
            });

        svg.call(zoom);

        const tree = d3.tree().size([width, height]).nodeSize([40, 65]); 
        const root = d3.hierarchy(treeData, d => d.children);

        root.sort((a, b) => a.data.name.localeCompare(b.data.name));

        tree(root);

        const link = g.selectAll(".link")
            .data(root.links())
            .enter().append("path")
            .attr("class", "link")
            .attr("d", d => `M${d.source.x},${d.source.y}L${d.source.x},${d.target.y}L${d.target.x},${d.target.y}`)
            .attr("fill", "none")
            .attr("stroke", "var(--text-color)")
            .attr("stroke-width", 1);  // Thinner lines

        const node = g.selectAll(".node")
            .data(root.descendants())
            .enter().append("g")
            .attr("class", d => "node" + (d.children ? " node--internal" : " node--leaf"))
            .attr("transform", d => "translate(" + d.x + "," + d.y + ")");

        
        node.append("circle")
            .attr("r", 30)
            .attr("fill", d => d.data.type === "leaf" ? "green" : "var(--accent-color)")
            .attr("stroke", "var(--text-color)")
            .attr("stroke-width", 1);

        node.append("text")
            .attr("dy", 3)
            .attr("x", 0)
            .attr("text-anchor", "middle")
            .attr("fill", "var(--text-color)")
            .attr("font-size", "8px")  // Smaller font
            .text(d => d.data.name);
        
        // Clear RAM on page unload
        window.addEventListener('beforeunload', function() {
            d3.select("#tree-container").html("");
        });
    </script>
{% endblock %}